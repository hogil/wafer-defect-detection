#!/usr/bin/env python3
"""
ğŸ§ª Code Test - ì½”ë“œ ë™ì‘ í™•ì¸ìš© í…ŒìŠ¤íŠ¸
"""

import sys
import torch
import numpy as np
from pathlib import Path

# í”„ë¡œì íŠ¸ ê²½ë¡œ ì¶”ê°€
sys.path.append('.')

def test_imports():
    """ë¼ì´ë¸ŒëŸ¬ë¦¬ import í…ŒìŠ¤íŠ¸"""
    print("ğŸ§ª Testing imports...")
    
    try:
        import torch
        import torchvision
        import timm
        import ultralytics
        import sklearn
        import cv2
        from PIL import Image
        print("âœ… All imports successful")
        return True
    except ImportError as e:
        print(f"âŒ Import error: {e}")
        return False

def test_gradcam():
    """GradCAM í´ë˜ìŠ¤ í…ŒìŠ¤íŠ¸"""
    print("\nğŸ§ª Testing GradCAM...")
    
    try:
        from gradcam_utils import GradCAMAnalyzer, extract_roi_from_heatmap
        
        # ë”ë¯¸ ëª¨ë¸ ìƒì„±
        import timm
        model = timm.create_model('convnextv2_base.fcmae_ft_in22k_in1k', pretrained=False, num_classes=5)
        
        # GradCAM ì´ˆê¸°í™”
        gradcam = GradCAMAnalyzer(model, "stages.3")
        
        # ë”ë¯¸ ì…ë ¥ìœ¼ë¡œ í…ŒìŠ¤íŠ¸
        dummy_input = torch.randn(1, 3, 384, 384)
        heatmap = gradcam.generate_gradcam(dummy_input, target_class=0)
        
        # ROI ì¶”ì¶œ í…ŒìŠ¤íŠ¸
        roi_coords = extract_roi_from_heatmap(heatmap)
        
        print(f"âœ… GradCAM test passed - Heatmap shape: {heatmap.shape}, ROI: {roi_coords}")
        return True
        
    except Exception as e:
        print(f"âŒ GradCAM test failed: {e}")
        return False

def test_wafer_detector():
    """WaferDetector í´ë˜ìŠ¤ í…ŒìŠ¤íŠ¸"""
    print("\nğŸ§ª Testing WaferDetector...")
    
    try:
        from wafer_detector import WaferDetector
        
        # ë”ë¯¸ ì„¤ì •
        config = {
            'CLASSIFICATION_SIZE': 384,
            'YOLO_SIZE': 1024,
            'F1_THRESHOLD': 0.8,
            'CONFIDENCE_THRESHOLD': 0.7,
            'MAPPING_THRESHOLD': 0.3
        }
        
        # ê²€ì¶œê¸° ì´ˆê¸°í™”
        detector = WaferDetector(config)
        
        print("âœ… WaferDetector initialization successful")
        
        # í´ë˜ìŠ¤ ì •ë³´ ì„¤ì • í…ŒìŠ¤íŠ¸
        detector.classes = ['normal', 'crack', 'scratch']
        detector.difficult_classes = ['crack']
        detector.roi_patterns = {
            'crack': {'x1': 0.2, 'y1': 0.3, 'x2': 0.7, 'y2': 0.8}
        }
        detector.class_object_mapping = {'crack': 'line'}
        
        print("âœ… WaferDetector configuration successful")
        return True
        
    except Exception as e:
        print(f"âŒ WaferDetector test failed: {e}")
        return False

def test_main_imports():
    """Main ëª¨ë“ˆ import í…ŒìŠ¤íŠ¸"""
    print("\nğŸ§ª Testing main imports...")
    
    try:
        from main import CONFIG, run_pipeline, run_prediction
        print(f"âœ… Main imports successful - CONFIG keys: {list(CONFIG.keys())}")
        return True
        
    except Exception as e:
        print(f"âŒ Main import test failed: {e}")
        return False

def main():
    """ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"""
    print("ğŸš€ Starting code tests...\n")
    
    tests = [
        ("Basic Imports", test_imports),
        ("GradCAM Module", test_gradcam),
        ("WaferDetector Module", test_wafer_detector),
        ("Main Module", test_main_imports)
    ]
    
    results = []
    for test_name, test_func in tests:
        try:
            success = test_func()
            results.append((test_name, success))
        except Exception as e:
            print(f"âŒ {test_name} crashed: {e}")
            results.append((test_name, False))
    
    # ê²°ê³¼ ìš”ì•½
    print("\n" + "="*50)
    print("ğŸ¯ Test Results Summary:")
    print("="*50)
    
    passed = 0
    for test_name, success in results:
        status = "âœ… PASS" if success else "âŒ FAIL"
        print(f"{test_name:20s} {status}")
        if success:
            passed += 1
    
    print(f"\nTotal: {passed}/{len(results)} tests passed")
    
    if passed == len(results):
        print("\nğŸ‰ All tests passed! Code is ready to run.")
    else:
        print(f"\nâš ï¸ {len(results) - passed} test(s) failed. Check dependencies and code.")

if __name__ == "__main__":
    main()
