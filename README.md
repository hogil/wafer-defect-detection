# 🎯 지능형 웨이퍼 결함 검출 시스템

> **"어려운 클래스에는 더 정밀한 분석을"** - 선택적 정밀도 기반 2단계 검출 시스템

---

## 💡 핵심 아이디어

### 기존 방식의 한계점
- 모든 클래스를 **동일한 방식**으로 처리
- 특정 "어려운 클래스"에서 **낮은 성능** 발생
- 미세한 크랙, 작은 오염 등은 정상 클래스 대비 **분류 난이도 높음**

### 새로운 접근법: **선택적 정밀도**
- 성능이 낮은 클래스만 **추가 정밀 분석** 수행
- 쉬운 클래스는 **빠른 기본 처리**로 효율성 확보
- 필요한 곳에만 **집중적 리소스 투입**

---

## 🏗️ 시스템 아키텍처

### **2단계 지능형 검출 파이프라인**

```
📊 성능 분석          🧠 ROI 학습          🎯 매핑 구축          🔍 실시간 예측
     ↓                    ↓                    ↓                    ↓
어려운 클래스 식별   → Grad-CAM 기반    → 클래스-객체 매핑   → 조건부 정밀 검증
(Precision < 0.8)          관심영역 추출         통계적 상관관계       (어려운 클래스만)
```

#### **1️⃣ 지능형 클래스 분류**
시스템이 **자동으로** 각 클래스의 난이도를 평가합니다.

**성능 기준 분류:**
- **쉬운 클래스**: Precision ≥ 0.8 (예: normal, clear_defects)
- **어려운 클래스**: Precision < 0.8 (예: micro_crack, contamination)

**Precision 사용 이유:**
- **F1 Score**: Precision과 Recall의 조화평균
- **Precision**: 해당 클래스로 예측했을 때 실제로 맞을 확률
- Precision이 낮다 = 그 클래스로 예측하면 **틀릴 가능성 높음** = 추가 검증 필요

#### **2️⃣ 동적 ROI 패턴 학습**
어려운 클래스에 대해서만 **모델의 attention 영역**을 분석합니다.

**Grad-CAM 기반 접근:**
- 모델이 **실제로 주목하는 영역** 추출
- 클래스별 **대표적 관심영역(ROI)** 패턴 학습
- 통계적 방법으로 **신뢰할 수 있는 ROI** 결정

#### **3️⃣ 데이터 기반 객체 매핑**
ROI 영역에서 검출되는 객체와 클래스 간의 **상관관계**를 구축합니다.

**매핑 구축 과정:**
- 각 어려운 클래스의 ROI에서 **YOLO 객체 검출** 수행
- 클래스별로 **가장 빈번한 객체** 식별
- 신뢰도 임계값(30%) 이상인 **확실한 매핑**만 저장

---

## 🔄 동작 시나리오

### **시나리오 A: 쉬운 클래스 OR 높은 신뢰도**
```
📸 이미지 입력 → 🤖 기본 분류 → ✅ 즉시 결과 반환
```

**조건:**
- 쉬운 클래스 (Precision ≥ 0.8) **또는** 높은 신뢰도 (≥ 70%)

**특징:**
- **1단계만** 사용하여 빠른 처리
- 추가 검증 불필요
- 전체 시스템 **효율성 극대화**

### **시나리오 B: 어려운 클래스 + 낮은 신뢰도**
```
📸 이미지 입력 → 🤖 기본 분류 → ⚠️ 조건 만족 → 🎯 ROI 검증 → 🔍 객체 검출 → 💭 역매핑 → ✅ 최종 결과
```

**조건 (2가지 모두 만족해야 함):**
1. 어려운 클래스로 예측됨 (Precision < 0.8)
2. 낮은 신뢰도 (< 70%)

**정밀 분석 과정:**
1. **ROI 적용**: 사전 학습된 관심영역 패턴 사용
2. **객체 검출**: YOLO를 통한 ROI 내 객체 분석  
3. **역매핑**: 가장 많이 검출된 객체로부터 최종 클래스 결정

**결과 예시:**
- 🔄 **클래스 변경**: "scratch" → "blob" 객체 검출 → "contamination"
- ✅ **클래스 유지**: "crack" → "line" 객체 검출 → "crack" (신뢰도 0.9로 상승)

---

## 🧠 핵심 기술 요소

### **Grad-CAM 기반 동적 ROI**

**기존 방식의 한계:**
- 고정된 중앙 영역 또는 전체 이미지 분석
- 결함 유형별 **위치적 특성 무시**

**지능형 ROI 추출:**
- 모델이 **실제로 중요하게 보는 영역** 식별
- 클래스별 **서로 다른 attention 패턴** 학습
- 예측 시 **동적으로 최적 ROI** 적용

**클래스별 ROI 특성 예시:**
- `crack`: 중앙-상단, 세로로 긴 형태
- `contamination`: 전체 영역 분산, 넓은 패턴
- `scratch`: 중앙 집중, 정사각형 형태

### **통계적 클래스-객체 매핑**

**데이터 기반 신뢰성:**
- 실제 검출 통계를 바탕으로 **객관적 매핑** 구축
- 임계값 기반 **확실한 관계**만 활용
- 노이즈나 우연의 일치 **자동 필터링**

**매핑 예시:**
```
crack 클래스 ROI 분석:
  - "line" 객체: 90% 빈도 → 매핑 생성 ✅
  - "blob" 객체: 8% 빈도 → 매핑 제외 ❌
  - "spot" 객체: 2% 빈도 → 매핑 제외 ❌
```

### **조건부 처리 최적화**

**2가지 조건을 모두 만족할 때만 정밀 분석:**
1. **성능 조건**: 어려운 클래스로 분류됨 (Precision < 0.8)
2. **신뢰도 조건**: 기본 분류 신뢰도 < 70%

**시스템 효율성:**
- 불필요한 연산 **최소화**
- 필요한 곳에만 **리소스 집중**
- 전체적으로 **빠른 처리 속도** 유지

---

## 🚀 혁신적 차별점

### **기존 방식 vs 새로운 방식**

| 구분 | 기존 방식 | 지능형 2단계 방식 |
|------|-----------|-------------------|
| **처리 방식** | 모든 클래스 동일 처리 | 클래스별 차별화 처리 |
| **정확도** | 평균적 성능 | 어려운 클래스 특화 향상 |
| **효율성** | 고정적 리소스 사용 | 적응적 리소스 배분 |
| **해석성** | 블랙박스 결과 | 명확한 판단 근거 제시 |
| **확장성** | 새로운 클래스 추가 어려움 | 자동 학습 및 적응 |

### **패러다임 전환**

**"모든 클래스를 동일하게"** ➜ **"어려운 클래스는 더 정밀하게"**

이는 단순한 기술적 개선이 아닌, **웨이퍼 결함 검출의 새로운 패러다임**입니다. 제한된 리소스를 가장 필요한 곳에 집중 투입하여, 전체 시스템의 성능과 효율성을 동시에 극대화하는 혁신적 접근법입니다.

---

*이 시스템은 실제 제조업 현장의 요구사항을 반영하여, 높은 정확도와 실시간 처리 속도를 모두 만족하는 실용적 솔루션을 제공합니다.*
